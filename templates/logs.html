{% extends "base.html" %}

{% block title %}Logs — Stockholm{% endblock %}

{% block content %}
<div class="animate-fade-in">
    {% if request.query_params.get('unlock') == '1' %}
    <div style="background: var(--signal-positive-bg); border: 1px solid var(--border-default); color: var(--text-primary); padding: var(--space-4) var(--space-5); margin-bottom: var(--space-6); font-weight: 500; display: flex; align-items: center; gap: var(--space-3);">
        <span>Login failure records unlocked successfully</span>
    </div>
    {% elif request.query_params.get('unlock') == 'all' %}
    <div style="background: var(--signal-positive-bg); border: 1px solid var(--border-default); color: var(--text-primary); padding: var(--space-4) var(--space-5); margin-bottom: var(--space-6); font-weight: 500; display: flex; align-items: center; gap: var(--space-3);">
        <span>All login failure records from the last 24h were cleared</span>
    </div>
    {% elif request.query_params.get('unlock') == 'error' %}
    <div style="background: rgba(248, 113, 113, 0.12); border: 1px solid rgba(248, 113, 113, 0.35); color: var(--text-primary); padding: var(--space-4) var(--space-5); margin-bottom: var(--space-6); font-weight: 500; display: flex; align-items: center; gap: var(--space-3);">
        <span>Please provide a username or IP to unlock.</span>
    </div>
    {% endif %}

    <!-- Page Header -->
    <header class="page-header">
        <div>
            <h1>System Logs</h1>
            <p>Scheduler activity and alert history</p>
        </div>
        
        <!-- Dev Mode Toggle -->
        <div class="dev-switch-row">
            <span class="dev-switch-label">DEV</span>
            <label class="dev-switch">
                <input type="checkbox" id="devModeToggle" {% if dev_mode %}checked{% endif %}>
                <span class="dev-track">
                    <span class="dev-thumb"></span>
                </span>
            </label>
        </div>
    </header>

    <!-- Scheduler Runs -->
    <div class="card" style="margin-bottom: var(--space-8);">
        <h3 style="margin: 0 0 var(--space-6) 0;">Scheduler Runs</h3>

        {% if scheduler_logs %}
        <div style="overflow-x: auto; margin: 0 calc(var(--space-6) * -1); padding: 0 var(--space-6);">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Stocks Scanned</th>
                        <th>Alerts Sent</th>
                        <th>Duration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in scheduler_logs %}
                    <tr>
                        <td style="font-family: var(--font-mono); font-size: 0.8125rem; color: var(--text-muted);">{{ log.run_at }}</td>
                        <td>
                            <span style="font-family: var(--font-mono); font-weight: 500;">{{ log.tickers_scanned }}</span>
                        </td>
                        <td>
                            <span style="font-family: var(--font-mono); font-weight: 500;">{{ log.alerts_sent }}</span>
                        </td>
                        <td style="font-family: var(--font-mono); font-size: 0.8125rem;">{{ "%.1f"|format(log.duration_seconds) }}s</td>
                        <td>
                            {% if log.errors %}
                            <span class="badge badge-danger" style="font-size: 0.625rem;">{{ log.errors[:30] }}...</span>
                            {% else %}
                            <span class="badge badge-success">OK</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">—</div>
            <p>No scheduler runs yet</p>
        </div>
        {% endif %}
    </div>

    <!-- Alert Lifecycle -->
    <div class="card" style="margin-bottom: var(--space-8);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-5); flex-wrap: wrap; gap: var(--space-3);">
            <h3 style="margin: 0;">Portfolio Alert Lifecycle</h3>
            <div style="display: flex; gap: var(--space-2); align-items: center;">
                <a href="/logs?alert_filter=active" class="btn {% if alert_filter == 'active' %}btn-primary{% else %}btn-ghost{% endif %}" style="font-size: 0.6875rem;">Active</a>
                <a href="/logs?alert_filter=all" class="btn {% if alert_filter == 'all' %}btn-primary{% else %}btn-ghost{% endif %}" style="font-size: 0.6875rem;">All (7d)</a>
            </div>
        </div>

        <div style="display: flex; gap: var(--space-5); margin-bottom: var(--space-4); flex-wrap: wrap; font-size: 0.75rem; color: var(--text-muted);">
            <span>Total active: <strong style="color: var(--text-primary);">{{ alert_summary.total_active|default(0) }}</strong></span>
            <span>Critical: <strong style="color: var(--text-primary);">{{ alert_summary.critical_count|default(0) }}</strong></span>
            <span>Warning: <strong style="color: var(--text-primary);">{{ alert_summary.warning_count|default(0) }}</strong></span>
        </div>

        {% if dedup_alerts %}
        <div style="overflow-x: auto; margin: 0 calc(var(--space-6) * -1); padding: 0 var(--space-6);">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Ticker</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Message</th>
                        <th>Status</th>
                        <th style="width: 120px;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in dedup_alerts %}
                    <tr>
                        <td style="font-family: var(--font-mono); font-size: 0.8125rem; color: var(--text-muted);">{{ alert.timestamp }}</td>
                        <td><span style="font-family: var(--font-mono); font-weight: 500;">{{ alert.ticker or '—' }}</span></td>
                        <td style="font-family: var(--font-mono); font-size: 0.75rem;">{{ alert.type }}</td>
                        <td>
                            {% if alert.severity == 'CRITICAL' %}
                            <span class="badge badge-danger">CRITICAL</span>
                            {% elif alert.severity == 'WARNING' %}
                            <span class="badge" style="background: rgba(250, 204, 21, 0.15); color: #d4a84b; border: 1px solid rgba(250, 204, 21, 0.3);">WARNING</span>
                            {% else %}
                            <span class="badge badge-secondary">{{ alert.severity or 'INFO' }}</span>
                            {% endif %}
                        </td>
                        <td style="font-size: 0.8125rem; color: var(--text-secondary);">{{ alert.message }}</td>
                        <td>
                            {% if alert.acknowledged %}
                            <span class="badge badge-secondary">Acknowledged</span>
                            {% else %}
                            <span class="badge badge-success">Active</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if not alert.acknowledged %}
                            <button class="btn btn-ghost" style="font-size: 0.6875rem;"
                                    onclick="ackAlert({{ alert.id }}, '{{ alert.alert_hash }}')">
                                Acknowledge
                            </button>
                            {% else %}
                            <span style="font-size: 0.6875rem; color: var(--text-muted);">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">—</div>
            <p>No deduplicated alerts in selected filter</p>
        </div>
        {% endif %}
    </div>

    <!-- Alerts Sent (legacy log) -->
    <div class="card">
        <h3 style="margin: 0 0 var(--space-6) 0;">Sent Alerts (Legacy Log)</h3>

        {% if alerts %}
        <div style="overflow-x: auto; margin: 0 calc(var(--space-6) * -1); padding: 0 var(--space-6);">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Ticker</th>
                        <th>Signal</th>
                        <th>Sent To</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in alerts %}
                    <tr>
                        <td style="font-family: var(--font-mono); font-size: 0.8125rem; color: var(--text-muted);">{{ alert.sent_at }}</td>
                        <td>
                            <span style="font-family: var(--font-mono); font-weight: 500;">{{ alert.ticker or '—' }}</span>
                        </td>
                        <td>
                            {% if alert.signal %}
                            <span class="signal-text signal-{{ alert.signal|lower }}">{{ alert.signal }}</span>
                            {% else %}
                            <span style="color: var(--text-muted);">—</span>
                            {% endif %}
                        </td>
                        <td style="font-size: 0.8125rem; color: var(--text-secondary);">{{ alert.sent_to }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">—</div>
            <p>No alerts sent yet</p>
        </div>
        {% endif %}
    </div>

    <!-- Login Security (Lockout/Backoff) -->
    <div class="card" style="margin-top: var(--space-8);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-5); gap: var(--space-3); flex-wrap: wrap;">
            <h3 style="margin: 0;">Login Security (Last 24h)</h3>
            <form method="post" action="/logs/login-failures/unlock-all" style="margin: 0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit"
                        class="btn btn-secondary"
                        style="font-size: 0.75rem;"
                        onclick="return confirm('Unlock all login failures from the last 24h?');">
                    Unlock All (24h)
                </button>
            </form>
        </div>

        <div style="display: flex; gap: var(--space-5); margin-bottom: var(--space-5); flex-wrap: wrap; font-size: 0.75rem; color: var(--text-muted);">
            <span>Failures: <strong style="color: var(--text-primary);">{{ login_fail_summary.total_failures|default(0) }}</strong></span>
            <span>Estimated Locked Users: <strong style="color: var(--text-primary);">{{ login_fail_summary.estimated_locked_users|default(0) }}</strong></span>
            <span>Policy: <strong style="color: var(--text-primary);">{{ login_fail_summary.max_attempts|default(5) }}</strong> fails / {{ login_fail_summary.window_minutes|default(15) }} min</span>
        </div>

        {% if recent_login_failures %}
        <div style="overflow-x: auto; margin: 0 calc(var(--space-6) * -1); padding: 0 var(--space-6);">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Username</th>
                        <th>IP Address</th>
                        <th style="width: 180px;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in recent_login_failures %}
                    <tr>
                        <td style="font-family: var(--font-mono); font-size: 0.8125rem; color: var(--text-muted);">{{ f.attempted_at }}</td>
                        <td style="font-family: var(--font-mono);">{{ f.username or 'unknown' }}</td>
                        <td style="font-family: var(--font-mono);">{{ f.ip_address or 'unknown' }}</td>
                        <td>
                            <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                                {% if f.username %}
                                <form method="post" action="/logs/login-failures/unlock" style="margin: 0;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="unlock_username" value="{{ f.username }}">
                                    <button type="submit" class="btn btn-ghost" style="font-size: 0.6875rem;">Unlock User</button>
                                </form>
                                {% endif %}
                                {% if f.ip_address %}
                                <form method="post" action="/logs/login-failures/unlock" style="margin: 0;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="unlock_ip" value="{{ f.ip_address }}">
                                    <button type="submit" class="btn btn-ghost" style="font-size: 0.6875rem;">Unlock IP</button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">—</div>
            <p>No failed login attempts in last 24 hours</p>
        </div>
        {% endif %}
    </div>

    <!-- System Logs (Dev Mode Only) -->
    {% if dev_mode %}
    <div class="card" style="margin-top: var(--space-8);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
            <h3 style="margin: 0;">Full System Logs (DEBUG)</h3>
            <div style="display: flex; gap: var(--space-2);">
                <button id="copyDevLogsBtn" onclick="copyAllDevLogs()" class="btn btn-ghost" style="font-size: 0.75rem; border-radius: 0;">
                    Copy All
                </button>
                <button onclick="clearDevLogs()" class="btn btn-ghost" style="font-size: 0.75rem; border-radius: 0;">
                    Clear
                </button>
                <button onclick="refreshDevLogs()" class="btn" style="font-size: 0.75rem; border-radius: 0;">
                    Refresh
                </button>
            </div>
        </div>
        
        <div id="devLogsContainer" style="background: #000; color: #fff; padding: var(--space-4); border-radius: 4px; font-family: var(--font-mono); font-size: 0.75rem; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-break: break-all;">
            {% if system_logs %}{{ system_logs }}{% else %}Loading logs...{% endif %}
        </div>
    </div>
    {% endif %}
</div>

<style>
.dev-switch-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.dev-switch-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    user-select: none;
}

.dev-switch {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 28px;
    cursor: pointer;
    margin: 0;
}

.dev-switch input {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}

.dev-track {
    position: absolute;
    inset: 0;
    background: #000;
    border: 2px solid #000;
    transition: background 0.2s;
}

.dev-thumb {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 18px;
    height: 18px;
    background: #fff;
    transition: transform 0.2s;
}

.dev-switch input:checked + .dev-track {
    background: #e5e5e5;
}

.dev-switch input:checked + .dev-track .dev-thumb {
    background: #000;
    transform: translateX(24px);
}

.dev-switch:hover .dev-track {
    border-color: #444;
}
</style>

<script>
const devModeToggle = document.getElementById('devModeToggle');

async function ackAlert(alertId, alertHash) {
    try {
        const response = await fetch('/api/portfolio/alerts/ack', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token }}'
            },
            body: JSON.stringify({ alert_id: alertId, alert_hash: alertHash })
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to acknowledge alert');
        }
    } catch (error) {
        console.error('Acknowledge error:', error);
        alert('Error acknowledging alert');
    }
}

if (devModeToggle) {
    devModeToggle.addEventListener('change', async function() {
        const isEnabled = this.checked;

        try {
            const response = await fetch('/toggle-dev-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ csrf_token }}'
                },
                body: JSON.stringify({ enabled: isEnabled })
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to toggle dev mode');
                this.checked = !isEnabled;
            }
        } catch (error) {
            console.error('Error toggling dev mode:', error);
            alert('Error toggling dev mode');
            this.checked = !isEnabled;
        }
    });
}

async function copyAllDevLogs() {
    const container = document.getElementById('devLogsContainer');
    const button = document.getElementById('copyDevLogsBtn');
    if (!container || !button) return;

    const text = container.textContent || '';
    if (!text.trim()) {
        button.textContent = 'Nothing to copy';
        setTimeout(() => { button.textContent = 'Copy All'; }, 1500);
        return;
    }

    try {
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
        } else {
            const temp = document.createElement('textarea');
            temp.value = text;
            temp.style.position = 'fixed';
            temp.style.opacity = '0';
            document.body.appendChild(temp);
            temp.focus();
            temp.select();
            document.execCommand('copy');
            temp.remove();
        }

        button.textContent = 'Copied';
        setTimeout(() => { button.textContent = 'Copy All'; }, 1500);
    } catch (error) {
        console.error('Copy logs failed:', error);
        button.textContent = 'Copy failed';
        setTimeout(() => { button.textContent = 'Copy All'; }, 1500);
    }
}

function clearDevLogs() {
    const container = document.getElementById('devLogsContainer');
    container.textContent = 'Logs cleared (display only)';
}

async function refreshDevLogs() {
    const container = document.getElementById('devLogsContainer');
    // Check if user is scrolled near the bottom before updating
    const wasAtBottom = (container.scrollHeight - container.scrollTop - container.clientHeight) < 30;

    try {
        const response = await fetch('/dev-logs');
        const data = await response.json();
        container.textContent = data.logs || 'No logs available';
        // Only auto-scroll if user was already at the bottom
        if (wasAtBottom) {
            container.scrollTop = container.scrollHeight;
        }
    } catch (error) {
        container.textContent = 'Error loading logs: ' + error.message;
    }
}

// Auto-refresh dev logs every 5 seconds if in dev mode
{% if dev_mode %}
setInterval(refreshDevLogs, 5000);
{% endif %}
</script>

{% endblock %}
